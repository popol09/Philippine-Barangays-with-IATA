<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barangay Search with Province & City</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
  <h1 class="text-3xl font-bold mb-4">Philippine Address</h1>

  <!-- Total Result Count -->
  <p id="resultCount" class="text-lg text-gray-700 mb-4">Total Results: 0</p>

  <!-- Row 1: Barangay, City/Municipality, Province -->
  <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <input id="searchBarangay" type="text" placeholder="ðŸ” Search Barangay name (min 3 chars)..." class="p-3 rounded-xl border border-gray-300" />
    <input id="searchCity" type="text" placeholder="ðŸ™ï¸ Search City/Municipality name (min 3 chars)..." class="p-3 rounded-xl border border-gray-300" />
    <input id="searchProvince" type="text" placeholder="ðŸ—ºï¸ Search Province name (min 3 chars)..." class="p-3 rounded-xl border border-gray-300" />
  </div>

  <!-- Row 2: IATA, District, Region -->
  <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <input id="searchIATA" type="text" placeholder="ðŸ›« Search IATA Code (min 2 chars)..." class="p-3 rounded-xl border border-gray-300" />
    <input id="searchDistrict" type="text" placeholder="ðŸ›ï¸ Search District (min 3 chars)..." class="p-3 rounded-xl border border-gray-300" />
    <input id="searchRegion" type="text" placeholder="ðŸŒ Search Region (min 3 chars)..." class="p-3 rounded-xl border border-gray-300" />
  </div>

  <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-1 gap-4 mb-6">
    <!-- Optional Island Group -->
    <input id="searchIsland" type="text" placeholder="ðŸï¸ Search Island Group (min 3 chars)..." class="p-3 rounded-xl border border-gray-300" />
  </div>

  <div id="results" class="w-full max-w-xl space-y-4"></div>

  <script>
  (async () => {
    const [barangays, cities, municipalities, provinces, iataData, districts, regions] = await Promise.all([
      fetch('barangays.json').then(r => r.json()),
      fetch('cities.json').then(r => r.json()),
      fetch('municipalities.json').then(r => r.json()),
      fetch('provinces.json').then(r => r.json()),
      fetch('iata.json').then(r => r.json()),
      fetch('districts.json').then(r => r.json()),
      fetch('regions.json').then(r => r.json()),
    ]);

    const cityMap = new Map(cities.map(c => [c.code, c]));
    const muniMap = new Map(municipalities.map(m => [m.code, m]));
    const provMap = new Map(provinces.map(p => [p.code, p]));
    const iataMap = new Map(iataData.map(i => [i.province.trim().toLowerCase(), i.iata]));
    const districtMap = new Map(districts.map(d => [d.code, d]));
    const regionMap = new Map(regions.map(r => [r.code, r]));

    function resolveLocation(barangay) {
      const cityOrMuni = barangay.cityCode
        ? cityMap.get(barangay.cityCode)
        : muniMap.get(barangay.municipalityCode);

      let province = null;
      let provinceName = 'Unknown';
      let iataCode = 'N/A';

      const isNCR = !barangay.provinceCode && barangay.districtCode;

      if (isNCR) {
        provinceName = 'National Capital Region';
        iataCode = 'MNL';
      } else if (cityOrMuni && cityOrMuni.provinceCode) {
        province = provMap.get(cityOrMuni.provinceCode);
        provinceName = province?.name || 'Unknown';
        iataCode = iataMap.get(provinceName.trim().toLowerCase()) || 'N/A';
      }

      const district = districtMap.get(barangay.districtCode);
      const districtName = district?.name || 'N/A';

      const region = isNCR
        ? regionMap.get('130000000')
        : district
        ? regionMap.get(district.regionCode)
        : province?.regionCode
        ? regionMap.get(province.regionCode)
        : null;

      const regionName = region?.name || 'N/A';

      const islandGroupMap = {
        luzon: 'Luzon',
        visayas: 'Visayas',
        mindanao: 'Mindanao'
      };
      const islandGroupName = islandGroupMap[barangay.islandGroupCode?.toLowerCase()] || 'Unknown';

      return {
        cityMunicipalityName: cityOrMuni?.name || 'Unknown',
        provinceName,
        iataCode,
        districtName,
        regionName,
        islandGroupName
      };
    }

    const barangayInput = document.getElementById('searchBarangay');
    const cityInput = document.getElementById('searchCity');
    const provinceInput = document.getElementById('searchProvince');
    const iataInput = document.getElementById('searchIATA');
    const districtInput = document.getElementById('searchDistrict');
    const regionInput = document.getElementById('searchRegion');
    const islandInput = document.getElementById('searchIsland'); // Optional input (if added to HTML)
    const resultsDiv = document.getElementById('results');

    function showResults(matches) {
      const countDisplay = document.getElementById('resultCount');
      resultsDiv.innerHTML = '';

      countDisplay.textContent = `Total Results: ${matches.length}`;

      if (matches.length === 0) {
        resultsDiv.innerHTML = `<p class="text-center text-gray-500">No results found.</p>`;
        return;
      }

      matches.slice(0, 100).forEach(b => {
        const loc = resolveLocation(b);
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl shadow';
        div.innerHTML = `
          <p><strong>Barangay:</strong> ${b.name}</p>
          <p><strong>City/Municipality:</strong> ${loc.cityMunicipalityName}</p>
          <p><strong>Province:</strong> ${loc.provinceName}</p>
          <p><strong>District:</strong> ${loc.districtName}</p>
          <p><strong>Region:</strong> ${loc.regionName}</p>
          <p><strong>IATA Code:</strong> ${loc.iataCode}</p>
          <p><strong>Island Group:</strong> ${loc.islandGroupName}</p>
        `;
        resultsDiv.appendChild(div);
      });
    }

    function performSearch() {
      const barangayQuery = barangayInput.value.trim().toLowerCase();
      const cityQuery = cityInput.value.trim().toLowerCase();
      const provinceQuery = provinceInput.value.trim().toLowerCase();
      const iataQuery = iataInput.value.trim().toUpperCase();
      const districtQuery = districtInput.value.trim().toLowerCase();
      const regionQuery = regionInput.value.trim().toLowerCase();
      const islandQuery = islandInput ? islandInput.value.trim().toLowerCase() : '';

      let filtered = barangays;

      if (barangayQuery.length >= 3) {
        filtered = filtered.filter(b =>
          b.name.toLowerCase().includes(barangayQuery)
        );
      }

      if (cityQuery.length >= 3) {
        const matchingCityCodes = [
          ...cities.filter(c => c.name.toLowerCase().includes(cityQuery)).map(c => c.code),
          ...municipalities.filter(m => m.name.toLowerCase().includes(cityQuery)).map(m => m.code)
        ];

        filtered = filtered.filter(b =>
          (b.cityCode && matchingCityCodes.includes(b.cityCode)) ||
          (b.municipalityCode && matchingCityCodes.includes(b.municipalityCode))
        );
      }

      if (provinceQuery.length >= 3) {
        filtered = filtered.filter(b => {
          const loc = resolveLocation(b);
          return loc.provinceName.toLowerCase().includes(provinceQuery);
        });
      }

      if (iataQuery.length >= 2) {
        filtered = filtered.filter(b => {
          const loc = resolveLocation(b);
          return loc.iataCode.toUpperCase().includes(iataQuery);
        });
      }

      if (districtQuery.length >= 3) {
        filtered = filtered.filter(b => {
          const loc = resolveLocation(b);
          return loc.districtName.toLowerCase().includes(districtQuery);
        });
      }

      if (regionQuery.length >= 3) {
        filtered = filtered.filter(b => {
          const loc = resolveLocation(b);
          return loc.regionName.toLowerCase().includes(regionQuery);
        });
      }

      if (islandQuery.length >= 3) {
        filtered = filtered.filter(b => {
          const loc = resolveLocation(b);
          return loc.islandGroupName.toLowerCase().includes(islandQuery);
        });
      }

      if (
        barangayQuery.length < 3 &&
        cityQuery.length < 3 &&
        provinceQuery.length < 3 &&
        iataQuery.length < 2 &&
        districtQuery.length < 3 &&
        regionQuery.length < 3 &&
        (!islandInput || islandQuery.length < 3)
      ) {
        resultsDiv.innerHTML = '';
        return;
      }

      showResults(filtered);
    }

    barangayInput.addEventListener('input', performSearch);
    cityInput.addEventListener('input', performSearch);
    provinceInput.addEventListener('input', performSearch);
    iataInput.addEventListener('input', performSearch);
    districtInput.addEventListener('input', performSearch);
    regionInput.addEventListener('input', performSearch);
    if (islandInput) islandInput.addEventListener('input', performSearch);
  })();
</script>

</body>
</html>
